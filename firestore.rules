rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }

    function isAdmin() {
      return hasAnyRole(['admin', 'superadmin']);
    }

    function isSuperAdmin() {
      return hasRole('superadmin');
    }

    function isFarmer() {
      return hasRole('farmer');
    }

    function isWholesaler() {
      return hasRole('wholesaler');
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    function onlyModifies(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }

    // ============================================
    // USERS
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated();

      // Relaxed: allow authenticated or unauthenticated sign-up to create a user document.
      allow create: if hasRequiredFields(['name', 'email', 'role', 'createdAt'])
        && request.resource.data.role in ['farmer', 'buyer', 'wholesaler'];

      allow update: if (isOwner(userId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']))
        || isAdmin();

      allow delete: if false;
    }

    // ============================================
    // FARMS
    // ============================================
    match /farms/{farmId} {
      allow read: if isAuthenticated()
        && (resource.data.isActive == true || isAdmin());

      allow create: if isFarmer()
        && request.resource.data.ownerId == request.auth.uid
        && hasRequiredFields(['ownerId', 'ownerName', 'farmName', 'district', 'isActive', 'createdAt'])
        && request.resource.data.isActive == true;

      allow update: if (isOwner(resource.data.ownerId)
        && request.resource.data.ownerId == resource.data.ownerId)
        || (isAdmin() && onlyModifies(['verifiedByLPNM', 'verifiedAt', 'updatedAt']));

      allow delete: if isSuperAdmin();

      // Products subcollection
      match /products/{productId} {
        allow read: if isAuthenticated();

        allow create, update: if isOwner(
          get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId
        );

        allow delete: if isOwner(
          get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId
        );
      }
    }

    // ============================================
    // HARVEST PLANS
    // ============================================
    match /harvestPlans/{planId} {
      allow read: if isOwner(resource.data.ownerId) || isAdmin();

      allow create: if isFarmer()
        && request.resource.data.ownerId == request.auth.uid;

      allow update: if isOwner(resource.data.ownerId)
        && request.resource.data.ownerId == resource.data.ownerId;

      allow delete: if isOwner(resource.data.ownerId);
    }

    // ============================================
    // BUYER REQUESTS
    // ============================================
    match /buyerRequests/{requestId} {
      allow read: if isAuthenticated();

      allow create: if hasAnyRole(['buyer', 'wholesaler'])
        && request.resource.data.buyerId == request.auth.uid
        && request.resource.data.status == 'open';

      allow update: if (isOwner(resource.data.buyerId)
        && request.resource.data.buyerId == resource.data.buyerId)
        || (isFarmer()
            && resource.data.status == 'open'
            && request.resource.data.status == 'fulfilled');

      allow delete: if isOwner(resource.data.buyerId)
        && resource.data.status == 'open';
    }

    // ============================================
    // PRICE HISTORY
    // ============================================
    match /priceHistory/{historyId} {
      allow read: if isAuthenticated();
      // Allow authenticated users to log price history (creates only)
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ============================================
    // AUDIT LOGS
    // ============================================
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin()
        && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if false;
    }

    // ============================================
    // ANNOUNCEMENTS
    // ============================================
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin()
        && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // ============================================
    // APP CONFIG
    // ============================================
    match /appConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ============================================
    // COLLECTION GROUP QUERIES
    // ============================================
    // Allow reading products across all farms (for market comparison)
    match /{path=**}/products/{productId} {
      allow read: if isAuthenticated();
    }
  }
}
